---
title: "Watercraft Inspection Steward Program Summary Report"
output:
  pdf_document: default
---



```{r setup, include=FALSE}
this.date <- format(Sys.Date(), format="%m/%d/%Y")
this.year <- substring(this.date,7,10)


library(arcgisbinding)
arc.check_product()
arc.check_portal()
wfs <- arc.open("https://services6.arcgis.com/DZHaqZm9cxOD4CWM/ArcGIS/rest/services/WISPA_2019/FeatureServer/0?token=i1zXPDAqPNZaSAnaNLerk1lfeTrpty3pUWOpf0F8Uk9VTZrSSDEA7-G6GqoCpD2ibVnOL_zjWznINWJ9dWFfiUommboAQOAyhVtxX3Rsseip-6RaC8coAnOtVhKIProGVZXd88ofVxZKF-llcgrrSYsTtxsWiI-HIuzPfEwtXcDz96bswnL-xiMDItbGOifoiztXiJFl0nZR0MSP11lDYfIQKSYOfPL7qzmzI12-JoIQELHDQXqTHyjcbhs46Dj_")
WISP_Raw <- arc.select(wfs)

library(kableExtra)
library(tidyverse)
library(openxlsx)
library(ggplot2)
library(lubridate)
library(kableExtra)
library(scales)
library(knitr)


WISP_SLELO <- filter(WISP_Raw, OrgID == "SLELO") #& Launch.Name != "TestBoatLaunch")



names(WISP_SLELO)[names(WISP_SLELO) == "Launch"] <- "Launch.Name"
names(WISP_SLELO)[names(WISP_SLELO) == "Date"] <- "Survey.Date"
names(WISP_SLELO)[names(WISP_SLELO) == "Total.watercraft:"] <- "Total.Watercraft"
names(WISP_SLELO)[names(WISP_SLELO) == "Direction2018"] <- "Direction"

WISP_SLELO$DayofWeek <- NA #add blank column for day of week
WISP_SLELO <- mutate(WISP_SLELO, DayofWeek = weekdays(as.Date(WISP_SLELO$Survey.Date))) #calculate day of week

WISP_SLELO <- mutate(WISP_SLELO, Survey.Date = format(as.POSIXct(WISP_SLELO$Survey.Date, format='%m/%d/%Y %H:%M:%S'),format='%m/%d/%Y'))#remove time string from survey date


#rename species columns
names(WISP_SLELO)[names(WISP_SLELO) == "NumBythotrephes"] <- "spiny/Fishhook.Water.flea"
names(WISP_SLELO)[names(WISP_SLELO) == "NumCeratophyllumdemersum"] <- "Coontail"
names(WISP_SLELO)[names(WISP_SLELO) == "NumCorbiculafluminea"] <- "Asian.Clam"
names(WISP_SLELO)[names(WISP_SLELO) == "NumDreissenabugensis"] <- "Quagga.Mussel"
names(WISP_SLELO)[names(WISP_SLELO) == "NumEgeriadensa"] <- "Brazilian.elodea"
names(WISP_SLELO)[names(WISP_SLELO) == "NumElodeaspp"] <- "Elodea.spp"
names(WISP_SLELO)[names(WISP_SLELO) == "NumFaxoniusrusticus"] <- "Rusty.crayfish"
names(WISP_SLELO)[names(WISP_SLELO) == "NumDreissenapolymorpha"] <- "Zebra.Mussel"
names(WISP_SLELO)[names(WISP_SLELO) == "NumMyriophyllumheterophyllum"] <- "Variable-leaf.Milfoil"
names(WISP_SLELO)[names(WISP_SLELO) == "NumMyriophyllumspicatum"] <- "Eurasian.Watermilfoil"
names(WISP_SLELO)[names(WISP_SLELO) == "NumPotamogetoncrispus"] <- "Curly.Leaf.Pondweed"
names(WISP_SLELO)[names(WISP_SLELO) == "NumHydrillaverticillata"] <- "Hydrilla"
names(WISP_SLELO)[names(WISP_SLELO) == "NumNitellopsisobtusa"] <- "Starry.Stonewort"
names(WISP_SLELO)[names(WISP_SLELO) == "NumMiscDebris"] <- "Misc.Debris"
names(WISP_SLELO)[names(WISP_SLELO) == "NumHydrocharismorsusranae"] <- "Frog.bit"
names(WISP_SLELO)[names(WISP_SLELO) == "NumTrapanatans"] <- "Water.Chestnut"
names(WISP_SLELO)[names(WISP_SLELO) == "NumUtriculariaspp"] <- "Bladderwort.spp"
names(WISP_SLELO)[names(WISP_SLELO) == "NumVallisneriaamericana"] <- "Tape.grass"
names(WISP_SLELO)[names(WISP_SLELO) == "NumNajasminor"] <- "Brittle.naiad"
names(WISP_SLELO)[names(WISP_SLELO) == "NumPotamogetonspp"] <- "Pondweed.spp"
names(WISP_SLELO)[names(WISP_SLELO) == "NumUnknown"] <- "Unknown"
names(WISP_SLELO)[names(WISP_SLELO) == "NumNymphaeaceae"] <- "Water.lily.spp."

launching <- filter(WISP_SLELO, Direction=="Launching") 
retrieving <- filter(WISP_SLELO, Direction=="Retrieving") 


total.crafts.launching <- sum(launching$ttlWatercraft)
total.crafts.retrieving <- sum(retrieving$ttlWatercraft)
total.watercraft <- sum(WISP_SLELO$ttlWatercraft)

total.people <- sum(as.integer(WISP_SLELO$GroupSize))
total.people.launching <- sum(as.integer(launching$GroupSize))
total.people.retrieving <- sum(as.integer(retrieving$GroupSize))

total.dirty <- WISP_SLELO %>% filter(InspectAgree=="Yes") %>% filter(AnythingDetect=="Yes") %>% tally()
total.consent <- WISP_SLELO %>% filter(InspectAgree=="Yes") %>% tally()

percent.consent <- round((total.consent/count(WISP_SLELO)*100), digits = 0)
percent.dirty <- round((total.dirty/count(WISP_SLELO)*100), digits = 0)

```

## SLELO Summary Statistics:
### This report provides draft statistics for SLELO's `r this.year` Watercraft Inspection Steward Program as of **`r this.date`**.

#### Total Watercraft Inspections:

  * A total of **`r comma(as.numeric(total.watercraft))`** watercraft were documented in **`r comma(as.numeric(count(WISP_SLELO)))`** surveys (Figure 1), including:
    + `r comma(as.numeric(total.crafts.launching))` vessels tallied upon launch (`r comma(as.numeric(count(launching)))` surveys)
    + `r comma(as.numeric(total.crafts.retrieving))` vessels tallied upon retrieval (`r comma(as.numeric(count(retrieving)))` surveys)
  
````{r echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}

#bar chart of total by direction
C.Direction <- WISP_SLELO %>% group_by(Direction) %>% tally()
ggplot(C.Direction, aes(x=Direction, y=n, label=(n)))+
  geom_bar(stat="identity", aes(fill=Direction))+
  labs(x="Direction", y="Number of Inspections", caption ="Figure 1. Total inspections by direction (2021).")+
  geom_label(position = position_stack(vjust = 0.5))

````


````{r plot by launch, echo=FALSE, fig.width=10, fig.height=10}

#bar chart of total by launch

C.Launch <- WISP_SLELO %>% group_by(Launch.Name) %>% tally() %>% arrange(desc(n)) %>% top_n(10)
ggplot(C.Launch, aes(x=reorder(Launch.Name, -n), y=n, label=(n)))+
  geom_bar(stat="identity", aes(fill=Launch.Name))+
  geom_label(position = position_stack(vjust = 0.5))+
  labs(x="Launch Name", y="Number of Inspections", caption =(paste("Figure 2. Total inspections by launch - top 10 sites ","(",this.year,")", sep="")))+
  theme(axis.text.x = element_text(angle = 90), legend.position="none")

AllRegState <-  filter(WISP_SLELO, RegState != "NotRegistered"&RegState!="unkown" ) %>% group_by(RegState) %>% tally()
AllRegState <- arrange(AllRegState, desc(n))

KnownReg <- sum(AllRegState$n)

NyReg <- filter(WISP_SLELO, RegState == "NY") %>% group_by(RegState) %>% tally()

total.reg.unk <- filter(WISP_SLELO, RegState=="unkown"|RegState=="NotRegistered") %>% group_by(RegState) %>% tally() 


````
\newpage

#### Total Contacts

* A total of **`r comma(as.numeric(total.people))`** people have been contacted, including:
    + `r comma(as.numeric(total.people.launching))` upon launch
    + `r comma(as.numeric(total.people.retrieving))` upon retrieval

* Registrations were observed from **`r count(AllRegState)`** states or provinces. NY represented `r round((NyReg$n/(KnownReg))*100, 0)`% of known registrations. `r sum(total.reg.unk$n)` surveys included unregistered vessels or boats with an unknown registration state/province. The top five registration states are shown above

````{r regstates, echo=FALSE}
TopRegState <- arrange(AllRegState, desc(n)) %>% top_n(5)
kable((TopRegState), "latex", longtable = T, booktabs = T, caption="Top five vessel registration states.")

````

\newpage  

````{r compliance, include=FALSE}
total.Nconsent <- WISP_SLELO %>% filter(InspectAgree == "No") %>% group_by(Launch.Name ) %>% tally() %>% arrange(desc(n))
total.bylaunch <- WISP_SLELO %>% group_by(Launch.Name ) %>% tally() %>% arrange(desc(n))
Total.NConsent.Merge <- merge(total.Nconsent, total.bylaunch, by.x="Launch.Name", by.y="Launch.Name", keep.x=TRUE)

names(Total.NConsent.Merge)[names(Total.NConsent.Merge) == "n.x"] <- "No.Consent"
names(Total.NConsent.Merge)[names(Total.NConsent.Merge) == "n.y"] <- "Total"
Total.NConsent.Merge$PercentNoConsent <- round((Total.NConsent.Merge$No.Consent/Total.NConsent.Merge$Total)*100,1)
Total.NConsent.Merge <-  Total.NConsent.Merge %>% arrange(desc(PercentNoConsent))
Total.NConsent.Merge %>% arrange(desc(PercentNoConsent)) %>% top_n(3)
Top.Nos <- paste(Total.NConsent.Merge$Launch.Name[1:3], collapse=", ")

Total.NConsent.Merge$Percent.Declining.Inspection <- paste(Total.NConsent.Merge$PercentNoConsent, "%", " (n=", Total.NConsent.Merge$No.Consent, ")",  sep="")
Total.NConsent.Merge$No.Consent <-  Total.NConsent.Merge$Total <- Total.NConsent.Merge$PercentNoConsent <-  NULL

````


#### Inspection Compliance:


* **`r comma(as.numeric(total.consent))`** groups (`r percent.consent`%) consented to inspection. In total, **`r comma(as.numeric(total.dirty))`** inspections (`r percent.dirty`%) had one or more organisms present and the vessel was categorized as "dirty".

* Inspection was most likely to be declined at **`r Top.Nos`**. For a full list of sites where inspection was declined, see table 2.
````{r no conest table, echo=FALSE}
kable((Total.NConsent.Merge), "latex", longtable = T, booktabs = T, caption="Sites with inspections declined.")

````
  
    
#### Specied Detected:



````{r species detected prep, echo=FALSE}

#pivot to long and remvoe lines where inspection was declined
Species.Detect <- pivot_longer(
  WISP_SLELO,
  'spiny/Fishhook.Water.flea':'Unknown', 
  names_to = "Species_Name",
  values_to = "Species_Detected",
  values_drop_na = TRUE
) %>% filter(InspectAgree == "Yes")

Species.Detect$Native.Invasive <- NA #add blank column for native/invasive status


# replace 0/1 values with detected/not-detected
Species.Detect$Species_Detected[Species.Detect$Species_Detected == '0'] <- "Not Detected"
Species.Detect$Species_Detected[Species.Detect$Species_Detected == '1'] <- "Detected"


#Assign native/invasive status column
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Curly.Leaf.Pondweed'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'spiny/Fishhook.Water.flea'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Asian.Clam'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Quagga.Mussel'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Zebra.Mussel'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Brazilian.elodea'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Rusty.crayfish'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Hydrilla'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Frog.bit'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Variable-leaf.Milfoil'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Eurasian.Watermilfoil'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Brittle.naiad'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Starry.Stonewort'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Water.Chestnut'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Coontail'] <- "Native/Unknown"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Elodea.spp'] <- "Native/Unknown"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Misc.Debris'] <- "Native/Unknown"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Bladderwort.spp'] <- "Native/Unknown"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Tape.grass'] <- "Native/Unknown"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Pondweed.spp'] <- "Native/Unknown"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Unknown'] <- "Native/Unknown"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Water.lily.spp.'] <- "Native/Unknown"


````

````{r species detected counts, echo=FALSE}
total.species <- Species.Detect %>% filter(Species_Detected=="Detected") %>% tally()

  
total.invasive <- Species.Detect %>% filter(Species_Detected=="Detected") %>% filter(Native.Invasive=="Invasive") %>% tally()


````


* A total of **`r comma(as.numeric(total.species))`** species were identified on **`r comma(as.numeric(total.dirty))`** dirty boats, including **`r comma(as.numeric(total.invasive))`** invasive species.

````{r, layout="l-body-outset", echo=FALSE}
library(knitr)
Invasive.Direction.sum <- Species.Detect %>% filter(Species_Detected=="Detected") %>% filter(Native.Invasive == "Invasive") %>% count(Species_Name, Native.Invasive, Direction)
Invaisve.Wide <- pivot_wider(Invasive.Direction.sum, id_cols="Species_Name", names_from = "Direction", values_from="n")
Invaisve.Wide[is.na(Invaisve.Wide)] = 0
kable((Invaisve.Wide), "latex", longtable = T, booktabs = T,  caption="Count of invaisve species observations by direction.")
````





````{r species plot, echo=FALSE}
#summarize all species detected by direction
All.Species.Sum <- Species.Detect %>% filter(Species_Detected=="Detected") %>% count(Species_Name, Direction, Species_Detected)

#Summarize invasive species by direction
Invasive.Direction.sum <- Species.Detect %>% filter(Species_Detected=="Detected") %>% filter(Native.Invasive == "Invasive") %>% count(Species_Name, Native.Invasive, Direction)

Native.Direction.sum <- Species.Detect %>% filter(Species_Detected=="Detected") %>% filter(Native.Invasive == "Native/Unknown") %>% count(Species_Name, Native.Invasive, Direction)


#ggplot(All.Species.Sum, aes(reorder(x=Species_Name, -n), y=n, label=(n)))+
#  geom_bar(stat="identity", aes(fill=Species_Name))+
#  geom_label(position = position_stack(vjust = 0.5))+
#  #labs(x="Species", y="Number of Detections")+
#  theme(axis.text.x = element_text(angle = 90), legend.position= "none")+
#  facet_grid(cols= vars(Direction)) 


All.Species.Wide <- pivot_wider(All.Species.Sum, id_cols="Species_Name", names_from = "Direction", values_from="n")
All.Species.Wide[is.na(All.Species.Wide)] = 0
kable((All.Species.Wide), "latex", longtable = T, booktabs = T,  caption="Count of all species observations by direction.")


````

\newpage
#### Previous Waterbody Visits:

````{r echo=FALSE}
Prev.Wtr.Yes <- filter(WISP_SLELO, Wtr2Wks == "YesDifferentWaterbody"|Wtr2Wks == "YesSameWaterbody")


````


Of the `r comma(as.numeric(count(launching)))` surveys for launching vessels, **`r comma(as.numeric(count(Prev.Wtr.Yes)))` (`r round(((count(Prev.Wtr.Yes))/(count(launching))*100),0)`%)** respondents reported visiting a waterbody within the previous two weeks. Of these, `r comma(as.numeric(filter(Prev.Wtr.Yes, Wtr2Wks == "YesSameWaterbody") %>% tally()))` reported visiting the same waterbody and `r comma(as.numeric(filter(Prev.Wtr.Yes, Wtr2Wks == "YesDifferentWaterbody") %>% tally()))` reported visiting a different waterbody. A full summary of previous waterbody visit data for launching vessels is provided in the table(s) below.

````{r prev data, echo=FALSE}
Prev.Wtr.Type <- filter(WISP_SLELO, Direction =="Launching") %>% group_by(Wtr2Wks) %>% tally() %>% arrange(desc(n))
library(knitr)
kable((Prev.Wtr.Type), "latex", longtable = T, booktabs = T,  caption="Count of invaisve species observations by direction.")

````


````{r prev water, echo=FALSE}
Diff.Wtr.Other <- filter(WISP_SLELO, Direction =="Launching" & PrevWaterbody == "other" & Wtr2Wks == "YesDifferentWaterbody")
Diff.Wtr.Other <- mutate(Diff.Wtr.Other, PrevWaterbody = PrevWaterbodyOther)

Diff.Wtr <- filter(WISP_SLELO, Direction =="Launching"& PrevWaterbody != "other" & Wtr2Wks == "YesDifferentWaterbody")
All.Prev.Wtr <- rbind(Diff.Wtr.Other, Diff.Wtr) %>% group_by(PrevWaterbody) %>% tally() %>% arrange(desc(n))


library(knitr)
kable((All.Prev.Wtr), "latex", longtable=T, booktabs = T, caption="Waterbodies visited by vessels within two weeks of launch.") %>% kable_styling(latex_options=c("repeat_header"), font_size=7)
````

\newpage
#### Summary of Launch Coverage and Inspections:

* The following table summarizes boater/inspection volume by launch and day of the week including:
  + Total Survey Count - the total number of surveys record at the specified launch on the specified day
  + Average Daily Surveys - the average number of surveys recorded at the specified launch on the specified day
  + Days of Coverage - the total number of day the specified launch had coverage on the specified day. Note: if a launch had no surveys recorded on a given, it is not accounted for in this tally.

````{r day summary, echo=FALSE}

DaySummary <- WISP_SLELO %>% group_by(Launch.Name, DayofWeek) %>% tally()
DaySummary$SummaryID <- NA #add blank column for ID
DaySummary$AverageSurveys <- NA #add blank column to populate later with average surveys
DaySummary$DaysofCoverage <- NA #add blank column to populate later with unique count
DaySummary <- mutate(DaySummary, SummaryID = paste(Launch.Name, DayofWeek, sep="-")) #createuniqueID

#how many days of coverage by launch and day of week
DayCount <- WISP_SLELO %>% group_by(Launch.Name, DayofWeek) %>% summarise(count= n_distinct(Survey.Date)) 
DayCount$CountID <- NA #add blank column for ID
DayCount <- mutate(DayCount, CountID = paste(Launch.Name, DayofWeek, sep="-")) #createuniqueID



DaySummary2 <- WISP_SLELO %>% group_by(Launch.Name, DayofWeek, Survey.Date) %>% tally() #summarize by launch, day, and survey date
DayAgg <- aggregate(x=DaySummary2$n,
                    by=list(DaySummary2$Launch.Name,DaySummary2$DayofWeek),
                    FUN = mean) #aggregate mean values
DayAgg <- mutate(DayAgg, x = round(x, 0)) %>% arrange(Group.1)
DayAgg$AverageID <- NA #add blank column for ID
DayAgg <- mutate(DayAgg, AverageID = paste(Group.1, Group.2, sep="-")) #createuniqueID

#merge data
CoverageSummary <- merge(DaySummary, DayAgg, by.x="SummaryID", by.y="AverageID", all.x=TRUE)
CoverageSummaryFull <- merge(CoverageSummary, DayCount, by.x="SummaryID", by.y="CountID", all.x=TRUE)


#calculate fields 
CoverageSummaryFull <- mutate(CoverageSummaryFull, AverageSurveys = x)
CoverageSummaryFull <- mutate(CoverageSummaryFull, DaysofCoverage = count)



#remove extraneous columns
CoverageSummaryFull$Group.1 <- CoverageSummaryFull$SummaryID <- CoverageSummaryFull$Group.2 <- CoverageSummaryFull$x <- CoverageSummaryFull$x <- CoverageSummaryFull$Launch.Name.y <- CoverageSummaryFull$count <- CoverageSummaryFull$DayofWeek.y <-NULL

names(CoverageSummaryFull)[names(CoverageSummaryFull) == "DayofWeek.x"] <- "Day"
names(CoverageSummaryFull)[names(CoverageSummaryFull) == "n"] <- "Total Survey Count"
names(CoverageSummaryFull)[names(CoverageSummaryFull) == "AverageSurveys"] <- "Average Daily Surveys"
names(CoverageSummaryFull)[names(CoverageSummaryFull) == "DaysofCoverage"] <- "Days of Coverage"

CoverageSummaryFull$Day <- factor(CoverageSummaryFull$Day, levels=c("Monday", "Tuesday","Wednesday", "Thursday","Friday","Saturday","Sunday"))

CoverageSummaryFull <- arrange(CoverageSummaryFull,Launch.Name.x, CoverageSummaryFull$Day)
names(CoverageSummaryFull)[names(CoverageSummaryFull) == "Launch.Name.x"] <- "Launch Name"



kable((CoverageSummaryFull), "latex", longtable = T, booktabs = T, caption="Summary of inspection by launch and day of week.") %>% kable_styling(latex_options=c("repeat_header"), font_size=7)


````


\newpage
## Statewide Statistics

### Total number of surveys by program

A total of `r comma(as.numeric(count(WISP_Raw)))` surveys have been submitted across the state. Approximately `r round((count(WISP_SLELO)/count(WISP_Raw)*100),0)`% of all surveys are from the SLELO PRISM. 


````{r statewide surveys, echo=FALSE}

names(WISP_Raw)[names(WISP_Raw) == "Direction2018"] <- "Direction"

Org.Tally <- WISP_Raw %>% group_by(OrgID, Direction) %>% tally()

Org.Freq <- aggregate(Org.Tally$n, by=list(Category=Org.Tally$OrgID), FUN=sum)

Org.Tally <- merge(Org.Tally, Org.Freq, by.x="OrgID", by.y="Category", keep.x=TRUE) 
Org.Tally2 <- arrange(Org.Tally, desc(x)) %>% top_n(16)

ggplot(Org.Tally2, aes(fill=Direction, x=reorder(OrgID, -n), y=n))+
  geom_text(aes(label=stat(y), group = OrgID), stat = 'summary', fun = sum, vjust=3, size=3)+
  geom_bar(stat="identity", position = "stack")+
  labs(x="Program", y="Number of Inspections", caption ="Figure 2. Total number of surveys by organization (2021).")+
  theme(axis.text.x = element_text(angle = 90))

````

### Total number of watercraft inspected by program

A total of `r comma(as.numeric(sum(as.integer(WISP_Raw$ttlWatercraft))))` watercraft have been inspected across the state. Approximately `r round((sum(as.integer(WISP_SLELO$ttlWatercraft))/sum(as.integer(WISP_Raw$ttlWatercraft))*100),0)`% of all watercraft were inspected in the SLELO PRISM. 

````{r statewide ttl watercraft, echo=FALSE}

Watercraft.Tally <- aggregate(WISP_Raw$ttlWatercraft, by=list(Category=WISP_Raw$OrgID, WISP_Raw$Direction), FUN=sum)
Watercraft.Freq <- aggregate(WISP_Raw$ttlWatercraft, by=list(Category=WISP_Raw$OrgID), FUN=sum)
Watercraft.Ttl.Merge <- merge(Watercraft.Tally, Watercraft.Freq, by.x="Category", by.y="Category", keep.x=TRUE) 

Watercraft.Ttl.Merge2 <- arrange(Watercraft.Ttl.Merge, desc(x.y)) %>% top_n(16)
names(Watercraft.Ttl.Merge2)[names(Watercraft.Ttl.Merge2) == "Group.2"] <- "Direction"

ggplot(Watercraft.Ttl.Merge2, aes(fill=Direction, x=reorder(Category, -x.y), y=x.x))+
  geom_text(aes(label=stat(y), group = Category), stat = 'summary', fun = sum, vjust=3, size=3)+
  geom_bar(stat="identity", position = "stack")+
  labs(x="Program", y="Number of Watercraft", caption ="Figure 2. Total number of watercraft inspected by organization (2021).")+
  theme(axis.text.x = element_text(angle = 90))


````

### Statewide Inspection Compliance

````{r prep, include=FALSE}

statewide.consent <- WISP_Raw %>% filter(InspectAgree=="Yes") %>% group_by(OrgID) %>% tally()
names(statewide.consent)[names(statewide.consent) == "n"] <- "Total.Consented"
statewide.byprogram <- WISP_Raw  %>% group_by(OrgID) %>% tally()
names(statewide.byprogram)[names(statewide.byprogram) == "n"] <- "Total.Surveys"
Consent.Merge <- merge(statewide.byprogram, statewide.consent, by.x="OrgID", by.y="OrgID", keep.x=TRUE)
Consent.Merge$Percent.Consent <- NA
Consent.Merge <- mutate(Consent.Merge, Percent.Consent = (Consent.Merge$Total.Consented/Consent.Merge$Total.Surveys)*100) 
Consent.Merge <- mutate(Consent.Merge, Percent.Consent=round(Percent.Consent, digits=2)) %>% filter(OrgID != "FLPRISM")
Consent.Merge.Plot <- arrange(Consent.Merge, desc(Percent.Consent)) %>% top_n(12)

Diff.State <- if((round((total.consent/count(WISP_SLELO)*100), digits = 0)<(round(mean(Consent.Merge.Plot$Percent.Consent),2)))){
  print("slightly below average")
} else{
  print("slightly above average")
}

````
Average inspection compliance across all NYS programs is **`r round(mean(Consent.Merge.Plot$Percent.Consent),0)`%**. SLELO program compliance is **`r Diff.State`** at approximately **`r percent.consent`%** compliance.

````{r statewide ttl compliance, echo=FALSE}

ggplot(Consent.Merge.Plot, aes(x=reorder(OrgID, -Percent.Consent), y=Percent.Consent))+
  geom_bar(stat="identity", fill="#3f97b4")+
  labs(x="Program", y="Percent Consenting to Inspection", caption ="Figure 2. Inspection compliation (%) by organization (2021).")+
  geom_text(aes(label=Percent.Consent, vjust = 3), color = "white", size = 3)+
  theme(axis.text.x = element_text(angle = 90))

````
