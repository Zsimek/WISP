---
title: "Watercraft Inspection Steward Program Summary Report"
output:
  pdf_document: default
  html_document:
    df_print: paged
---



```{r get raw, include=FALSE}
this.date <- format(Sys.Date(), format="%m/%d/%Y")
this.year <- substring(this.date,7,10)

library(kableExtra)
library(tidyverse)
library(openxlsx)
library(ggplot2)
library(lubridate)
library(kableExtra)
library(scales)
library(knitr)
library(arcgisbinding)
arc.check_product()
arc.check_portal()
wfs <- arc.open("https://services6.arcgis.com/DZHaqZm9cxOD4CWM/arcgis/rest/services/WISPA_2019/FeatureServer/0?token=SktEmf5o_tRhNdY7MLEzjXRqG_KhqO033rONXEt_koLurhUETEM7aFYEtnR7epVKEte89Ikfh_XzKxHspUcdVKEx3J4ZOSmRLfs70U358lrPI8WTSd4ZxYSyfSvkSR2jQ9727kMe5Uf2lfH0LGEjsMQDQljHjrQduofk6-OSoGfqFm_CIGd0VedpKijqgtwoFirod9DLewdB1VPGEyg3y8dgh9XOqyO8ONJO5h2VsfHaAfus3ws2O5gZTPOVBU2Q")
WISP_Raw <- arc.select(wfs)


angler <- arc.open("https://services6.arcgis.com/DZHaqZm9cxOD4CWM/ArcGIS/rest/services/WISPA_Angler_Survey_Read_Only/FeatureServer/0?token=2l6Up7pG3c174Z4Fbi2KpT7m0pD2COmw2IlmgIffqdj1toudrlLdAvXSuePVonHuOkHV2qC_mYXBiosrQCsZ0pf3QlGc7xP-ItqLT19WJtjW5Pv6Lp-fxbScNAYfP8e4tltyM6-IupUZxQvC_sMKrsfuuoOb8mN8Fdzex95ayk_MXHJHPk7ualn_UOmhwEHIrCmyW4Ihi0ZTkLfAS4B42MD03p7quQS2cFrznMfazFnTKw4-z5ag9zxKIPVNmaNA")
walkup <- arc.open("https://services6.arcgis.com/DZHaqZm9cxOD4CWM/ArcGIS/rest/services/WISPA_Walk_Up_App_View_Only/FeatureServer/0?token=wtlPF-eR7L_gg9EscalJ1jL-_g7pSHKdETK6GooV34LJ3BZx8YCaG-bUi2jUEPESMg6vXHvB7B4nucCyyEAX7JzRiK6-VUKPckNFL_2lUr6sny4Sgb37oHDeXGMThhiZn0ahJh_NS3OdjUhNf3dMI1GmtqvagWepCOO2vdZ6PZXZl2uUOHCYBFEDamiPv3BJgX4d2vf4PlL4yl1ofF3ji8BDZNYnZxbm0xKvYakaRm49-zmOqoAnX9bFMGsofiY-")
anglerdata <- arc.select(angler) %>% filter(OrgID == "SLELO") %>% filter(Launch != 'TestBoatLaunch')
walkupdata <- arc.select(walkup) %>% filter(wispa_organization_id == "SLELO") %>% filter(Launch != 'TestBoatLaunch')

SLELO.wfs <- arc.open("https://services6.arcgis.com/DZHaqZm9cxOD4CWM/ArcGIS/rest/services/WISPA_2019_SLELO/FeatureServer/0?token=Ujj_dlXF8REvjYLKM9hF0VDcr0YYgVcUliaucZk6a-AhJT-_IgqsQyuHvJDLGcOXQN2i7N0Gbt4K3J-EljNXivoZR_WH7IUe8z36XURA6L7rupzGOnkcFHRDNnulIlsd203cUvRmAnw3SWhW-W-gvK17DtuefjeNqCgJjsiSvyWVHipTwJfzb4p9x8rBk8Yh3qd_PMISj0N8IOdLY0h_jpbJWTXAdPXJG-oOfmR_18-mn6cwDJCvO8nUW-o7eH0T")
```

```{r setup, include=FALSE}
WISP_SLELO <- filter(WISP_Raw, OrgID == "SLELO") #& Launch.Name != "TestBoatLaunch")

names(WISP_SLELO)[names(WISP_SLELO) == "Launch"] <- "Launch.Name"
names(WISP_SLELO)[names(WISP_SLELO) == "Date"] <- "Survey.Date"
names(WISP_SLELO)[names(WISP_SLELO) == "Total.watercraft:"] <- "Total.Watercraft"
names(WISP_SLELO)[names(WISP_SLELO) == "Direction2018"] <- "Direction"

WISP_SLELO$DayofWeek <- NA #add blank column for day of week
WISP_SLELO <- mutate(WISP_SLELO, DayofWeek = weekdays(as.Date(WISP_SLELO$Survey.Date))) #calculate day of week

WISP_SLELO <- mutate(WISP_SLELO, Survey.Date = format(as.POSIXct(WISP_SLELO$Survey.Date, format='%m/%d/%Y %H:%M:%S'),format='%m/%d/%Y'))#remove time string from survey date

SLELO_Writeable <- arc.select(SLELO.wfs)

#rename species columns
names(WISP_SLELO)[names(WISP_SLELO) == "NumBythotrephes"] <- "spiny/Fishhook.Water.flea"
names(WISP_SLELO)[names(WISP_SLELO) == "NumCeratophyllumdemersum"] <- "Coontail"
names(WISP_SLELO)[names(WISP_SLELO) == "NumCorbiculafluminea"] <- "Asian.Clam"
names(WISP_SLELO)[names(WISP_SLELO) == "NumDreissenabugensis"] <- "Quagga.Mussel"
names(WISP_SLELO)[names(WISP_SLELO) == "NumEgeriadensa"] <- "Brazilian.elodea"
names(WISP_SLELO)[names(WISP_SLELO) == "NumElodeaspp"] <- "Elodea.spp"
names(WISP_SLELO)[names(WISP_SLELO) == "NumFaxoniusrusticus"] <- "Rusty.crayfish"
names(WISP_SLELO)[names(WISP_SLELO) == "NumDreissenapolymorpha"] <- "Zebra.Mussel"
names(WISP_SLELO)[names(WISP_SLELO) == "NumMyriophyllumheterophyllum"] <- "Variable-leaf.Milfoil"
names(WISP_SLELO)[names(WISP_SLELO) == "NumMyriophyllumspicatum"] <- "Eurasian.Watermilfoil"
names(WISP_SLELO)[names(WISP_SLELO) == "NumPotamogetoncrispus"] <- "Curly.Leaf.Pondweed"
names(WISP_SLELO)[names(WISP_SLELO) == "NumHydrillaverticillata"] <- "Hydrilla"
names(WISP_SLELO)[names(WISP_SLELO) == "NumNitellopsisobtusa"] <- "Starry.Stonewort"
names(WISP_SLELO)[names(WISP_SLELO) == "NumMiscDebris"] <- "Misc.Debris"
names(WISP_SLELO)[names(WISP_SLELO) == "NumHydrocharismorsusranae"] <- "Frog.bit"
names(WISP_SLELO)[names(WISP_SLELO) == "NumTrapanatans"] <- "Water.Chestnut"
names(WISP_SLELO)[names(WISP_SLELO) == "NumUtriculariaspp"] <- "Bladderwort.spp"
names(WISP_SLELO)[names(WISP_SLELO) == "NumVallisneriaamericana"] <- "Tape.grass"
names(WISP_SLELO)[names(WISP_SLELO) == "NumNajasminor"] <- "Brittle.naiad"
names(WISP_SLELO)[names(WISP_SLELO) == "NumPotamogetonspp"] <- "Pondweed.spp"
names(WISP_SLELO)[names(WISP_SLELO) == "NumUnknown"] <- "Unknown"
names(WISP_SLELO)[names(WISP_SLELO) == "NumNymphaeaceae"] <- "Water.lily.spp."

launching <- filter(WISP_SLELO, Direction=="Launching") 
retrieving <- filter(WISP_SLELO, Direction=="Retrieving") 

total.crafts.launching <- sum(launching$ttlWatercraft)
total.crafts.retrieving <- sum(retrieving$ttlWatercraft)
total.watercraft <- sum(WISP_SLELO$ttlWatercraft)

total.people <- sum(as.integer(WISP_SLELO$GroupSize))
total.people.launching <- sum(as.integer(launching$GroupSize))
total.people.retrieving <- sum(as.integer(retrieving$GroupSize))

total.dirty <- WISP_SLELO %>% filter(InspectAgree=="Yes") %>% filter(AnythingDetect=="Yes") %>% tally()
total.consent <- WISP_SLELO %>% filter(InspectAgree=="Yes") %>% tally()
total.consent.launch <- WISP_SLELO %>% filter(InspectAgree=="Yes" & Direction == "Launching") %>% tally()
total.consent.retrieve <- WISP_SLELO %>% filter(InspectAgree=="Yes" & Direction == "Retrieving") %>% tally()

percent.consent <- round((total.consent/count(WISP_SLELO)*100), digits = 0)
percent.dirty <- round((total.dirty/count(WISP_SLELO)*100), digits = 0)

#create total records dataframe
Source <- c('WISP', 'Walk Up', 'Angler')
count.wisp <- as.numeric(count(WISP_SLELO))
count.walkup <- as.numeric(count(walkupdata))
count.angler <- as.numeric(count(anglerdata))
Count <- c(count.wisp, count.walkup, count.angler)
total.records <- data.frame(Source, Count)

#create total visitor contacts dataframe
visitor.wisp <- as.numeric(sum(WISP_SLELO$GroupSize))
visitor.walkup <- as.numeric(sum(walkupdata$number_of_people_in_party))
visitor.angler <- as.numeric(sum(anglerdata$GroupSize))
Visitor.Count <- c(visitor.wisp, visitor.walkup, visitor.angler)
total.visitor.records <- data.frame(Source, Visitor.Count)


Species.Detect <- pivot_longer(
  WISP_SLELO,
  'spiny/Fishhook.Water.flea':'Unknown', 
  names_to = "Species_Name",
  values_to = "Species_Detected",
  values_drop_na = TRUE
)


Species.Detect$Native.Invasive <- NA #add blank column for native/invasive status


# replace 0/1 values with detected/not-detected
Species.Detect$Species_Detected[Species.Detect$Species_Detected == '0'] <- "Not Detected"
Species.Detect$Species_Detected[Species.Detect$Species_Detected == '1'] <- "Detected"


#Assign native/invasive status column
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Curly.Leaf.Pondweed'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'spiny/Fishhook.Water.flea'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Asian.Clam'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Quagga.Mussel'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Zebra.Mussel'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Brazilian.elodea'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Rusty.crayfish'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Hydrilla'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Frog.bit'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Variable-leaf.Milfoil'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Eurasian.Watermilfoil'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Brittle.naiad'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Starry.Stonewort'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Water.Chestnut'] <- "Invasive"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Coontail'] <- "Native/Unknown"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Elodea.spp'] <- "Native/Unknown"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Misc.Debris'] <- "Native/Unknown"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Bladderwort.spp'] <- "Native/Unknown"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Tape.grass'] <- "Native/Unknown"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Pondweed.spp'] <- "Native/Unknown"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Unknown'] <- "Native/Unknown"
Species.Detect$Native.Invasive[Species.Detect$Species_Name == 'Water.lily.spp.'] <- "Native/Unknown"

OtherSpecies <- read.xlsx("T:/CONSERVATION/CONSERVATION PROGRAMS/Invasives/Conservation and GIS Analyst Project/SLELO/WISPA/2021/OtherSpecies.xlsx", sheet = "Data")
OtherSpecies$Species_Detected <- "Detected"
names(OtherSpecies)[names(OtherSpecies) == "Select.all.other.species.detected:"] <- "Species_Name"
names(OtherSpecies)[names(OtherSpecies) == "Launch.*"] <- "Launch.Name"


Species.Detect.Sub <- select(Species.Detect, "Launch.Name", "Direction", "Species_Name", "Species_Detected", "Native.Invasive")

Species.Detect.All <- bind_rows(Species.Detect.Sub, OtherSpecies)

total.invasive <- Species.Detect.All %>% filter(Species_Detected=="Detected") %>% filter(Native.Invasive=="Invasive") %>% tally()
total.invasive <- Species.Detect.All %>% filter(Species_Detected=="Detected") %>% filter(Native.Invasive=="Invasive") %>% tally()

Invasive.Direction.sum <- Species.Detect.All %>% filter(Species_Detected=="Detected") %>% filter(Native.Invasive == "Invasive") %>% count(Species_Name, Native.Invasive, Direction)
Invaisve.Wide <- pivot_wider(Invasive.Direction.sum, id_cols="Species_Name", names_from = "Direction", values_from="n")
Invaisve.Wide[is.na(Invaisve.Wide)] = 0
Invaisve.Wide$Total <- Invaisve.Wide$Retrieving + Invaisve.Wide$Launching
Invaisve.Wide <- Invaisve.Wide %>%  arrange(desc(Total))

AnglerInspect <- anglerdata %>% group_by(InspectAgree) %>% tally() %>% arrange(desc(n))
anglersites <- anglerdata %>% group_by(Launch) %>% tally() %>% arrange(desc(n))
AggAngler <- aggregate(anglerdata$GroupSize, list(anglerdata$Launch), FUN=sum) %>% arrange(desc(x))
ainspectyes <- filter(AnglerInspect, InspectAgree =="yes")
ainspectno <- filter(AnglerInspect, InspectAgree =="no")

#get list of item types inspected
AnglerInsepctionItems <- filter(anglerdata, InspectAgree == 'yes') %>% 
  group_by(AnglerInspection) %>% tally() %>% arrange(desc(n)) %>% 
  drop_na

#separate strings of comma separated values
ItemList <- separate_rows(AnglerInsepctionItems, "AnglerInspection", sep=",", convert = TRUE ) 

#aggregate rows of item types and clean column names
ItemSummary <- aggregate(ItemList$n, list(ItemList$AnglerInspection), FUN=sum) %>% arrange(desc(x))

#rename columns for table
names(ItemSummary)[names(ItemSummary) == "x"] <- "Number of Responses"
names(ItemSummary)[names(ItemSummary) == "Group.1"] <- "Item Type"

AnglerPrevention <- filter(anglerdata, AnglerPrevention != "NotAsked") %>% group_by(AnglerPrevention) %>% tally() %>% arrange(desc(n))
AnglerPreventionYes <- filter(anglerdata, AnglerPrevention != "NotAsked" & AnglerPrevention != "None") %>% group_by(AnglerPrevention) %>% tally() %>% arrange(desc(n))

#get list of prevention actions
AnglerPrevention <- filter(anglerdata, AnglerPrevention != 'NotAsked') %>% 
  group_by(AnglerPrevention) %>% tally() %>% arrange(desc(n)) %>% 
  drop_na

#separate strings of comma separated values
PreventionList <- separate_rows(AnglerPrevention, "AnglerPrevention", sep=",", convert = TRUE ) 

#aggregate rows of item types and clean column names
PreventionSummary <- aggregate(PreventionList$n, list(PreventionList$AnglerPrevention), FUN=sum) %>% arrange(desc(x)) %>% filter(Group.1 != "None")

#rename columns for table
names(PreventionSummary)[names(PreventionSummary) == "x"] <- "Number of Responses"
names(PreventionSummary)[names(PreventionSummary) == "Group.1"] <- "Preventative Action"

LiveBait <- anglerdata %>% group_by(LiveBaitYN) %>% tally() %>% arrange(desc(n)) %>% drop_na() %>% filter(LiveBaitYN != "unsureNotAsked")
LiveBaityes <- filter(anglerdata, LiveBaitYN == "yes")

#get list of bait type actions
BaitSpecies <- LiveBaityes %>% group_by(LivebaitSpp) %>% tally() %>% arrange(desc(n)) %>% 
  drop_na

#separate strings of comma separated values
BaitList <- separate_rows(BaitSpecies, "LivebaitSpp", sep=",", convert = TRUE ) 

#aggregate rows of item types and clean column names
BaitSummary <- aggregate(BaitList$n, list(BaitList$LivebaitSpp), FUN=sum) %>% arrange(desc(x))

#rename columns for table
names(BaitSummary)[names(BaitSummary) == "x"] <- "Count"
names(BaitSummary)[names(BaitSummary) == "Group.1"] <- "Species"

AnglerInspected <- filter(anglerdata, InspectAgree =="yes")

Moist <- AnglerInspected %>% group_by(MoistureDetect) %>% tally()
moist.yes <- filter(Moist, MoistureDetect == "yes")
moist.yes.num <- as.integer(moist.yes$n)

OrgDetect <- AnglerInspected %>% group_by(AnythingDetect) %>% tally()
org.yes <- filter(OrgDetect, AnythingDetect == "yes")
org.yes.num <- as.integer(org.yes$n)

#get list of organisms detected
AnglerOrganisms <- filter(anglerdata, InspectAgree == 'yes' & AnythingDetect =="yes") %>% 
  group_by(OrganismDetect) %>% tally() %>% arrange(desc(n)) %>% 
  drop_na

#separate strings of comma separated values
aOrgList <- separate_rows(AnglerOrganisms, "OrganismDetect", sep=",", convert = TRUE ) 

#aggregate rows of item types and clean column names
aOrgSummary <- aggregate(aOrgList$n, list(aOrgList$OrganismDetect), FUN=sum) %>% arrange(desc(x))

#rename columns for table
names(aOrgSummary)[names(aOrgSummary) == "x"] <- "Number of Responses"
names(aOrgSummary)[names(aOrgSummary) == "Group.1"] <- "Organism"

C.Direction <- WISP_SLELO %>% group_by(Direction) %>% tally()

AllRegState <-  filter(WISP_SLELO, RegState != "NotRegistered"&RegState!="unkown" ) %>% group_by(RegState) %>% tally() %>% arrange(desc(n))
TopRegState <- arrange(AllRegState, desc(n)) %>% top_n(5)

#Total surveys by launch and direction
Launch.Summary <- WISP_SLELO %>% group_by(Launch.Name, Direction) %>% tally() %>% pivot_wider(id_cols="Launch.Name", names_from="Direction", values_from="n")
Launch.Summary$Total <- as.integer(Launch.Summary$Launching)+ as.integer(Launch.Summary$Retrieving)
Launch.Summary <- arrange(Launch.Summary, desc(Total))

measures.taken <- filter(WISP_SLELO, PreventMeasures2018 != "NA")

measures.sum <- filter(measures.taken, InspectAgree == 'Yes')
  measures.sum$PreventMeasures2018[measures.sum$PreventMeasures2018 == 'NotAsked'] <- "Other"
  measures.sum$PreventMeasures2018[measures.sum$PreventMeasures2018 == 'Refused'] <- "Other"
  measures.sum$PreventMeasures2018[measures.sum$PreventMeasures2018 == 'UNK'] <- "Other"

measures.sum <- measures.sum  %>% group_by(Direction, PreventMeasures2018) %>%  tally()


#get records for those who did take prevention measures
measures.yes <- filter(measures.taken, InspectAgree == 'Yes' & PreventMeasures2018 == "Yes")

measures.yes.sum <- measures.yes  %>% group_by(Direction) %>% tally()

list.measures <- measures.yes %>% group_by(Direction, PreventTaken) %>% tally()

ag.measures <- separate_rows(list.measures, PreventTaken, sep=",", convert= TRUE)
ag.measures.summary <- aggregate(ag.measures$n, list(ag.measures$Direction, ag.measures$PreventTaken), FUN=sum) %>% group_by(Group.1) %>% arrange(.by_group = TRUE, desc(x))
rm(ag.measures, list.measures)

#measures table
measures.table <- pivot_wider(ag.measures.summary, id_cols = Group.2, names_from = Group.1, values_from = x)
names(measures.table)[names(measures.table) == "Group.2"] <- "Preventative Measure"
measures.table$Total <- measures.table$Launching + measures.table$Retrieving





```

This report provides draft statistics for SLELO's `r this.year` Watercraft Inspection Steward Program data as of **`r this.date`**.

## Quick Stats:

  * Total Surveys Recorded: **`r comma(as.numeric(sum(total.records$Count)))`**
    + WISP: `r comma(as.numeric(count(WISP_SLELO)))` 
    + Walk-up: `r comma(as.numeric(count(walkupdata)))`
    + Angler: `r comma(as.numeric(count(anglerdata)))`
    
  * Total Visitor Contacts: **`r comma(as.numeric(sum(total.visitor.records$Visitor.Count)))`**
    + WISP: `r comma(as.numeric(sum(WISP_SLELO$GroupSize)))`
    + Walk-up: `r comma(as.numeric(sum(walkupdata$number_of_people_in_party)))`
    + Angler: `r comma(as.numeric(sum(anglerdata$GroupSize)))`
    
  * Total Inspections: **`r comma(as.numeric(total.watercraft)+as.numeric(count(anglerdata)))`**
    + Launching Watercraft: `r comma(as.numeric(total.crafts.launching))`
    + Retrieving Watercraft: `r comma(as.numeric(total.crafts.retrieving))`
    + Angler Inspections: `r comma(as.numeric(count(anglerdata)))`

  * Watercraft Inspection Compliance: **`r percent.consent`% of surveyed groups**
    
  * Total AIS Interceptions: **`r comma(as.numeric(total.invasive))`**
    + `r comma(as.numeric(sum(Invaisve.Wide$Launching)))` upon launch
    + `r comma(as.numeric(sum(Invaisve.Wide$Retrieving)))` upon retrieval



\newpage
## SLELO Summary Statistics:

### Total Watercraft Inspections:

  * A total of **`r comma(as.numeric(total.watercraft))`** watercraft were documented in **`r comma(as.numeric(count(WISP_SLELO)))`** surveys (Figure 1), including:
    + `r comma(as.numeric(total.crafts.launching))` vessels tallied upon launch (`r comma(as.numeric(count(launching)))` surveys)
    + `r comma(as.numeric(total.crafts.retrieving))` vessels tallied upon retrieval (`r comma(as.numeric(count(retrieving)))` surveys)
  
````{r echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}

#bar chart of total by direction
ggplot(C.Direction, aes(x=Direction, y=n, label=(n)))+
  geom_bar(stat="identity", aes(fill=Direction))+
  labs(x="Direction", y="Number of Inspections", caption ="Figure 1. Total inspections by direction (2021).")+
  geom_label(position = position_stack(vjust = 0.5))

````

\newpage
````{r launch summary table, echo=FALSE}
kable((Launch.Summary), "latex", longtable = T, booktabs = T, caption="Summary of surveys by launch and direction.")

````

````{r plot by launch, echo=FALSE, fig.width=10, fig.height=10}

#bar chart of total by launch

C.Launch <- WISP_SLELO %>% group_by(Launch.Name) %>% tally() %>% arrange(desc(n)) %>% top_n(10)
ggplot(C.Launch, aes(x=reorder(Launch.Name, -n), y=n, label=(n)))+
  geom_bar(stat="identity", aes(fill=Launch.Name))+
  geom_label(position = position_stack(vjust = 0.5))+
  labs(x="Launch Name", y="Number of Inspections", caption =(paste("Figure 2. Total inspections by launch - top 10 sites ","(",this.year,")", sep="")))+
  theme(axis.text.x = element_text(angle = 90), legend.position="none")

KnownReg <- sum(AllRegState$n)

NyReg <- filter(WISP_SLELO, RegState == "NY") %>% group_by(RegState) %>% tally()

total.reg.unk <- filter(WISP_SLELO, RegState=="unkown"|RegState=="NotRegistered") %>% group_by(RegState) %>% tally() 


````
\newpage

### Total Contacts

* A total of **`r comma(as.numeric(sum(total.visitor.records$Visitor.Count)))`** people were contacted, including:
    + `r comma(as.numeric(total.people.launching))` visitors upon watercraft launch
    + `r comma(as.numeric(total.people.retrieving))` visitors upon watercraft retrieval
    + `r comma(as.numeric(sum(walkupdata$number_of_people_in_party)))` walk-up visitors
    + `r comma(as.numeric(sum(anglerdata$GroupSize)))` anglers

* Boat registrations were observed from **`r count(AllRegState)`** states or provinces. NY represented `r round((NyReg$n/(KnownReg))*100, 0)`% of known registrations. `r sum(total.reg.unk$n)` surveys included unregistered vessels or boats with an unknown registration state/province. The top five registration states are shown above

````{r regstates, echo=FALSE}
kable((TopRegState), "latex", longtable = T, booktabs = T, caption="Top five vessel registration states.")

````

\newpage  

````{r compliance, include=FALSE}
total.Nconsent <- WISP_SLELO %>% filter(InspectAgree == "No") %>% group_by(Launch.Name ) %>% tally() %>% arrange(desc(n))
total.bylaunch <- WISP_SLELO %>% group_by(Launch.Name ) %>% tally() %>% arrange(desc(n))
Total.NConsent.Merge <- merge(total.Nconsent, total.bylaunch, by.x="Launch.Name", by.y="Launch.Name", keep.x=TRUE)

names(Total.NConsent.Merge)[names(Total.NConsent.Merge) == "n.x"] <- "No.Consent"
names(Total.NConsent.Merge)[names(Total.NConsent.Merge) == "n.y"] <- "Total"
Total.NConsent.Merge$PercentNoConsent <- round((Total.NConsent.Merge$No.Consent/Total.NConsent.Merge$Total)*100,1)
Total.NConsent.Merge <-  Total.NConsent.Merge %>% arrange(desc(PercentNoConsent))
Total.NConsent.Merge %>% arrange(desc(PercentNoConsent)) %>% top_n(3)
Top.Nos <- paste(Total.NConsent.Merge$Launch.Name[1:3], collapse=", ")

Total.NConsent.Merge$Percent.Declining.Inspection <- paste(Total.NConsent.Merge$PercentNoConsent, "%", " (n=", Total.NConsent.Merge$No.Consent, ")",  sep="")
Total.NConsent.Merge$No.Consent <-  Total.NConsent.Merge$Total <- Total.NConsent.Merge$PercentNoConsent <-  NULL

measures.yes <- filter(WISP_SLELO, InspectAgree == "Yes" & PreventMeasures2018 == "Yes")
measures.launch <- filter(measures.yes, Direction == "Launching") %>% tally()
measures.retrieve <- filter(measures.yes, Direction == "Retrieving") %>% tally()

````


### Inspection Compliance:


  * **`r comma(as.numeric(total.consent))` boating groups** (`r percent.consent`%) and **`r comma(as.numeric(ainspectyes$n))` anglers** (`r round((ainspectyes$n/((ainspectyes$n)+(ainspectno$n))*100),0)`%) consented to inspection.
    + **`r comma(as.numeric(total.dirty))`** boat inspections (`r percent.dirty`%) had one or more organisms present and the vessel was categorized as "dirty".
    + **`r org.yes.num`** angler inspections (`r round(org.yes.num/sum(OrgDetect$n)*100,0)`%) had one or more organisms present on gear.

* Of the `r comma(as.numeric(total.consent))` boating groups that consented to inspection, **`r round(((as.integer(count(measures.yes)))/as.numeric(total.consent))*100,0)`%** (n=`r comma(as.integer(count(measures.yes)))`) reported taking one or more spread prevention measures.
    + Approximately `r round((as.integer(measures.launch)/as.numeric(total.consent))*100,0)`% (n=`r comma(as.integer(measures.launch$n))`) of launching groups reported taking spread prevention measures
    + Approximately `r round((as.integer(measures.retrieve)/as.numeric(total.consent))*100,0)`% (n=`r comma(as.integer(measures.retrieve$n))`) of retrieving groups reported taking spread prevention measures

````{r no measures table, echo=FALSE}
kable((measures.table), "latex", longtable = T, booktabs = T, caption="Spread prevention measures reported by survey direction.")

````

* Boat inspection was most likely to be declined at **`r Top.Nos`** (Table 2).
````{r no conest table, echo=FALSE}
kable((Total.NConsent.Merge), "latex", longtable = T, booktabs = T, caption="Launch sites with inspections declined.")

````
  
\newpage    
### Specied Detected:

````{r species detected counts, include=FALSE}
total.species <- Species.Detect.All %>% filter(Species_Detected=="Detected") %>% tally()

Majority.Interceptions <- if((sum(Invaisve.Wide$Launching)) > (sum(Invaisve.Wide$Retrieving))){
  print("launching")
}else{
  print("retrieving")
}

Majority.Percent <- if(Majority.Interceptions == "retrieving"){
  print(round(((sum(Invaisve.Wide$Retrieving))/(sum(sum(Invaisve.Wide$Launching)+sum(Invaisve.Wide$Retrieving)))*100),0)
)
}else{
  print(round(((sum(Invaisve.Wide$Launching))/(sum(sum(Invaisve.Wide$Launching)+sum(Invaisve.Wide$Retrieving)))*100),0)
)
}

````


* A total of **`r comma(as.numeric(total.species))`** species were identified on **`r comma(as.numeric(total.dirty))`** dirty boats, including **`r comma(as.numeric(total.invasive))`** invasive species.
* The majority (`r Majority.Percent`%) of invasive species were intercepted on `r Majority.Interceptions` vessels. A total of `r sum(Invaisve.Wide$Launching)` invasive species were detected upon launch and `r sum(Invaisve.Wide$Retrieving)` upon retrieval.  

````{r, layout="l-body-outset", echo=FALSE}
kable((Invaisve.Wide), "latex", longtable = T, booktabs = T,  caption="Count of invaisve species observations by direction.")
````





````{r species plot, echo=FALSE}
#summarize all species detected by direction
All.Species.Sum <- Species.Detect.All %>% filter(Species_Detected=="Detected") %>% count(Species_Name, Direction, Species_Detected)

#Summarize invasive species by direction
Invasive.Direction.sum <- Species.Detect.All %>% filter(Species_Detected=="Detected") %>% filter(Native.Invasive == "Invasive") %>% count(Species_Name, Native.Invasive, Direction)

Native.Direction.sum <- Species.Detect.All %>% filter(Species_Detected=="Detected") %>% filter(Native.Invasive == "Native/Unknown") %>% count(Species_Name, Native.Invasive, Direction)


#ggplot(All.Species.Sum, aes(reorder(x=Species_Name, -n), y=n, label=(n)))+
#  geom_bar(stat="identity", aes(fill=Species_Name))+
#  geom_label(position = position_stack(vjust = 0.5))+
#  #labs(x="Species", y="Number of Detections")+
#  theme(axis.text.x = element_text(angle = 90), legend.position= "none")+
#  facet_grid(cols= vars(Direction)) 


All.Species.Wide <- pivot_wider(All.Species.Sum, id_cols="Species_Name", names_from = "Direction", values_from="n")
All.Species.Wide[is.na(All.Species.Wide)] = 0
kable((All.Species.Wide), "latex", longtable = T, booktabs = T,  caption="Count of all species observations by direction.")


````

\newpage
### Previous Waterbody Visits:

````{r echo=FALSE}
Prev.Wtr.Yes <- filter(WISP_SLELO, Wtr2Wks == "YesDifferentWaterbody"|Wtr2Wks == "YesSameWaterbody")
Prev.Wtr.Same <- filter(WISP_SLELO, Wtr2Wks == "YesSameWaterbody") %>% tally()
Prev.Wtr.Diff <- filter(WISP_SLELO, Wtr2Wks == "YesDifferentWaterbody") %>% tally()
````


Of the `r comma(as.numeric(count(launching)))` surveys performed on launching vessels, **`r comma(as.numeric(count(Prev.Wtr.Yes)))` (`r round(((count(Prev.Wtr.Yes))/(count(launching))*100),0)`%)** respondents reported visiting a waterbody within the previous two weeks. Of these, `r comma(as.numeric(Prev.Wtr.Same))` reported visiting the same waterbody and `r comma(as.numeric(Prev.Wtr.Diff))` reported visiting a different waterbody. A full summary of previous waterbody visit data for launching vessels is provided below (Table 5 & 6). 

````{r prev data, echo=FALSE}
Prev.Wtr.Type <- filter(WISP_SLELO, Direction =="Launching") %>% group_by(Wtr2Wks) %>% tally() %>% arrange(desc(n))
library(knitr)
kable((Prev.Wtr.Type), "latex", longtable = T, booktabs = T,  caption="Count of invaisve species observations by direction.")

````


````{r prev water, echo=FALSE}
Diff.Wtr.Other <- filter(WISP_SLELO, Direction =="Launching" & PrevWaterbody == "other" & Wtr2Wks == "YesDifferentWaterbody")
Diff.Wtr.Other <- mutate(Diff.Wtr.Other, PrevWaterbody = PrevWaterbodyOther)

Diff.Wtr <- filter(WISP_SLELO, Direction =="Launching"& PrevWaterbody != "other" & Wtr2Wks == "YesDifferentWaterbody")
All.Prev.Wtr <- rbind(Diff.Wtr.Other, Diff.Wtr) %>% group_by(PrevWaterbody) %>% tally() %>% arrange(desc(n))


library(knitr)
kable((All.Prev.Wtr), "latex", longtable=T, booktabs = T, caption="Waterbodies visited by vessels within two weeks of launch.") %>% kable_styling(latex_options=c("repeat_header"), font_size=7)
````

\newpage
### Summary of Launch Coverage and Inspections:

* The following table summarizes boater/inspection volume by launch and day of the week including:
  + Total Survey Count - the total number of surveys recorded at the specified launch on the specified day
  + Average Daily Surveys - the average number of surveys recorded at the specified launch on the specified day
  + Days of Coverage - the total number of day the specified launch had coverage on the specified day. Note: if a launch had no surveys recorded on a given day, it is not accounted for in this tally.

````{r day summary, include=FALSE}

DaySummary <- WISP_SLELO %>% group_by(Launch.Name, DayofWeek) %>% tally()
DaySummary$SummaryID <- NA #add blank column for ID
DaySummary$AverageSurveys <- NA #add blank column to populate later with average surveys
DaySummary$DaysofCoverage <- NA #add blank column to populate later with unique count
DaySummary <- mutate(DaySummary, SummaryID = paste(Launch.Name, DayofWeek, sep="-")) #createuniqueID

#how many days of coverage by launch and day of week
DayCount <- WISP_SLELO %>% group_by(Launch.Name, DayofWeek) %>% summarise(count= n_distinct(Survey.Date)) 
DayCount$CountID <- NA #add blank column for ID
DayCount <- mutate(DayCount, CountID = paste(Launch.Name, DayofWeek, sep="-")) #createuniqueID



DaySummary2 <- WISP_SLELO %>% group_by(Launch.Name, DayofWeek, Survey.Date) %>% tally() #summarize by launch, day, and survey date
DayAgg <- aggregate(x=DaySummary2$n,
                    by=list(DaySummary2$Launch.Name,DaySummary2$DayofWeek),
                    FUN = mean) #aggregate mean values
DayAgg <- mutate(DayAgg, x = round(x, 0)) %>% arrange(Group.1)
DayAgg$AverageID <- NA #add blank column for ID
DayAgg <- mutate(DayAgg, AverageID = paste(Group.1, Group.2, sep="-")) #createuniqueID

#merge data
CoverageSummary <- merge(DaySummary, DayAgg, by.x="SummaryID", by.y="AverageID", all.x=TRUE)
CoverageSummaryFull <- merge(CoverageSummary, DayCount, by.x="SummaryID", by.y="CountID", all.x=TRUE)


#calculate fields 
CoverageSummaryFull <- mutate(CoverageSummaryFull, AverageSurveys = x)
CoverageSummaryFull <- mutate(CoverageSummaryFull, DaysofCoverage = count)



#remove extraneous columns
CoverageSummaryFull$Group.1 <- CoverageSummaryFull$SummaryID <- CoverageSummaryFull$Group.2 <- CoverageSummaryFull$x <- CoverageSummaryFull$x <- CoverageSummaryFull$Launch.Name.y <- CoverageSummaryFull$count <- CoverageSummaryFull$DayofWeek.y <-NULL

names(CoverageSummaryFull)[names(CoverageSummaryFull) == "DayofWeek.x"] <- "Day"
names(CoverageSummaryFull)[names(CoverageSummaryFull) == "n"] <- "Total Survey Count"
names(CoverageSummaryFull)[names(CoverageSummaryFull) == "AverageSurveys"] <- "Average Daily Surveys"
names(CoverageSummaryFull)[names(CoverageSummaryFull) == "DaysofCoverage"] <- "Days of Coverage"

CoverageSummaryFull$Day <- factor(CoverageSummaryFull$Day, levels=c("Monday", "Tuesday","Wednesday", "Thursday","Friday","Saturday","Sunday"))

CoverageSummaryFull <- arrange(CoverageSummaryFull,Launch.Name.x, CoverageSummaryFull$Day)
names(CoverageSummaryFull)[names(CoverageSummaryFull) == "Launch.Name.x"] <- "Launch Name"
```

```{r table, echo=FALSE}

kable((CoverageSummaryFull), "latex", longtable = T, booktabs = T, caption="Summary of inspection by launch and day of week.") %>% kable_styling(latex_options=c("repeat_header"), font_size=7)

```



\newpage

```{r walkup, message=TRUE, warning=TRUE, echo=FALSE}

#get list of launches where walk up surveys occured
WalkUpSites <- walkupdata %>% group_by(Launch) %>% tally() %>% arrange(desc(n))
AggWalk <- aggregate(walkupdata$number_of_people_in_party, list(walkupdata$Launch), FUN=sum) %>% arrange(desc(x))

WalkUpSum <- merge(WalkUpSites, AggWalk, by.x="Launch", by.y="Group.1", all.x=TRUE) %>% arrange(desc(n))
WalkUpLocal <- walkupdata %>% group_by(are_you_local_to_the_area) %>% tally() %>% arrange(desc(n))
WalkUpFamiliar <- walkupdata %>% group_by(have_they_heard_of_invasive_spe) %>% tally() %>% arrange(desc(n))


toplaunch <- first(WalkUpSites$Launch)

TopWalkUp <- filter(WalkUpSum, Launch == toplaunch)


LocalYes <- filter(WalkUpLocal, are_you_local_to_the_area == 'yes')
LocalNo <- filter(WalkUpLocal, are_you_local_to_the_area == 'out_of_town')
Local.Yes.Value <- LocalYes$n
Local.No.Value <- LocalNo$n

FamYes <- filter(WalkUpFamiliar, have_they_heard_of_invasive_spe == 'yes')
FamNo <- filter(WalkUpFamiliar, have_they_heard_of_invasive_spe == 'no')
Familiar.Yes.Value <- FamYes$n
Familiar.No.Value <- FamNo$n

#get list of species types people are familar with
FamiliarSpecies <- filter(walkupdata, have_they_heard_of_invasive_spe == 'yes') %>% 
  group_by(if_yes_which_type_and_species) %>% tally() %>% arrange(desc(n)) %>% 
  drop_na

#separate strings of comma separated values
SpeciesList <- separate_rows(FamiliarSpecies, "if_yes_which_type_and_species", sep=",", convert = TRUE ) 

#aggregate rows of species types and clean column names
SpeciesSummary <- aggregate(SpeciesList$n, list(SpeciesList$if_yes_which_type_and_species), FUN=sum) %>% arrange(desc(x))

#rename columns for table
names(SpeciesSummary)[names(SpeciesSummary) == "x"] <- "Number of Responses"
names(SpeciesSummary)[names(SpeciesSummary) == "Group.1"] <- "Invasive Type"

#group count on data
count.on <- walkupdata %>% group_by(can_we_count_on_them_to_do_thei) %>% tally() %>% arrange(desc(n)) %>% drop_na

#isolate values for printing
count.yes <- filter(count.on, can_we_count_on_them_to_do_thei == 'yes')
count.poss <- filter(count.on, can_we_count_on_them_to_do_thei == 'possibly')
count.na <- filter(count.on, can_we_count_on_them_to_do_thei == 'not asked')
count.no <- filter(count.on, can_we_count_on_them_to_do_thei == 'no')

count.yes.value <- count.yes$n
count.poss.value <- count.poss$n
count.na.value <- count.na$n
count.no.value <- count.no$n

```

### Walkup Survey Results
* SLELO stewards recorded **`r count(walkupdata)`** walk-up surveys at **`r count(WalkUpSites)`** launch sites accounting for a total of **`r sum(AggWalk$x)`** visitor contacts (Table 8). **`r first(WalkUpSites$Launch)`** had the most walk-up surveys with **`r max(WalkUpSites$n)`** total records and **`r max(AggWalk$x)`** visitor contacts. Approximately **`r round((Local.Yes.Value/(Local.No.Value+Local.Yes.Value))*100,0)`%** of walk-up survey respondents indicated they were local, while **`r round((Local.No.Value/(Local.No.Value+Local.Yes.Value))*100,0)`%** indicated they were from 'out-of-town'.

````{r walk up site table, echo=FALSE}

kable((WalkUpSites), "latex", longtable = T, booktabs = T, caption="Locations where angler surveys were performed.") %>% kable_styling(latex_options=c("repeat_header"), font_size=7)


```

* Approximately **`r round((Familiar.Yes.Value/(Familiar.No.Value+Familiar.Yes.Value))*100,0)`%** of respondents (n=**`r Familiar.Yes.Value`**) indicated they had heard about invasive species, while **`r round((Familiar.No.Value/(Familiar.No.Value+Familiar.Yes.Value))*100,0)`%** were not familiar with invasive species.
  + Respondents who were familiar with invasive species acknowledged:

````{r species table, echo=FALSE}

kable((SpeciesSummary), "latex", longtable = T, booktabs = T, caption="Type of species walk-up respondents were familar with") %>% kable_styling(latex_options=c("repeat_header"), font_size=7)

```

* When asked if we can count on visitors to prevent the spread of invasive species **`r round((count.yes.value/sum(count.on$n))*100,0)`%** said 'yes' and **`r round((count.poss.value/sum(count.on$n))*100,0)`%** said 'possibly'. An additional `r count.na.value` groups were not asked (`r round((count.na.value/sum(count.on$n))*100,0)`% of sample). 

\newpage


### Angler Survey Results
* SLELO stewards recorded **`r count(anglerdata)`** angler surveys at **`r count(anglersites)`** launch sites for a total of **`r sum(AggAngler$x)`** visitor contacts (Table 10). **`r first(anglersites$Launch)`** had the most angler surveys with **`r max(anglersites$n)`** total records and **`r max(AggAngler$x)`** visitor contacts.

````{r angler site table, echo=FALSE}

kable((anglersites), "latex", longtable = T, booktabs = T, caption="Locations where angler surveys were performed.") %>% kable_styling(latex_options=c("repeat_header"), font_size=7)


```

* Approximately **`r round((ainspectyes$n/((ainspectyes$n)+(ainspectno$n))*100),0)`%** (n=`r ainspectyes$n`) of anglers consented to have their gear inspected. The items most commonly inspected by stewards were `r paste(ItemSummary$'Item Type'[1:3], " (n=", ItemSummary$'Number of Responses'[1:3], ")", sep="", collapse=", ")`, and `r paste(ItemSummary$'Item Type'[4], " (n=", ItemSummary$'Number of Responses'[4], ")", sep="", collapse=", ")`.
  + Stewards detected moisture during `r round(moist.yes.num/sum(Moist$n)*100,0)`% (n=`r moist.yes.num`) of inspections
  + Stewards detected organisms during `r round(org.yes.num/sum(OrgDetect$n)*100,0)`% (n=`r org.yes.num`) of inspections. The most commonly detected organisms were `r paste(aOrgSummary$Organism[1:2], " (n=", aOrgSummary$'Number of Responses'[1:2], ")", sep="", collapse=", ")`, and `r paste(aOrgSummary$Organism[3], " (n=", aOrgSummary$'Number of Responses'[3], ")", sep="", collapse=", ")`. 
  
* **`r round((sum(AnglerPreventionYes$n)/(sum(AnglerPrevention$n))*100),0)`%** of anglers asked about spread prevention measures reported taking one or more preventative actions. The most commonly reported actions were `r paste(PreventionSummary$'Preventative Action'[1:3], " (n=", PreventionSummary$'Number of Responses'[1:3], ")", sep="", collapse=", ")`, and `r paste(PreventionSummary$'Preventative Action'[4], " (n=", PreventionSummary$'Number of Responses'[4], ")", sep="", collapse=", ")`.    

* When asked, `r round((as.integer(count(LiveBaityes))/sum(LiveBait$n)*100),0)`% of anglers reported having live bait. The most commonly reported bait species were `r paste(BaitSummary$Species[1:3], " (n=", BaitSummary$Count[1:3], ")", sep="", collapse=", ")`, and `r paste(BaitSummary$Species[4], " (n=", BaitSummary$Count[4], ")", sep="", collapse=", ")`.





\newpage
## Statewide Statistics

### Total number of surveys by program

A total of `r comma(as.numeric(count(WISP_Raw)))` surveys have been submitted across the state. Approximately `r round((count(WISP_SLELO)/count(WISP_Raw)*100),0)`% of all surveys are from the SLELO PRISM. 


````{r statewide surveys, echo=FALSE}

names(WISP_Raw)[names(WISP_Raw) == "Direction2018"] <- "Direction"

Org.Tally <- WISP_Raw %>% group_by(OrgID, Direction) %>% tally()

Org.Freq <- aggregate(Org.Tally$n, by=list(Category=Org.Tally$OrgID), FUN=sum)

Org.Tally <- merge(Org.Tally, Org.Freq, by.x="OrgID", by.y="Category", keep.x=TRUE) 
Org.Tally2 <- arrange(Org.Tally, desc(x)) %>% top_n(16)

ggplot(Org.Tally2, aes(fill=Direction, x=reorder(OrgID, -n), y=n))+
  geom_text(aes(label=stat(y), group = OrgID), stat = 'summary', fun = sum, vjust=3, size=3)+
  geom_bar(stat="identity", position = "stack")+
  labs(x="Program", y="Number of Inspections", caption ="Figure 2. Total number of surveys by organization (2021).")+
  theme(axis.text.x = element_text(angle = 90))

````

### Total number of watercraft inspected by program

A total of `r comma(as.numeric(sum(as.integer(WISP_Raw$ttlWatercraft))))` watercraft have been inspected across the state. Approximately `r round((sum(as.integer(WISP_SLELO$ttlWatercraft))/sum(as.integer(WISP_Raw$ttlWatercraft))*100),0)`% of all watercraft were inspected in the SLELO PRISM. 

````{r statewide ttl watercraft, echo=FALSE}

Watercraft.Tally <- aggregate(WISP_Raw$ttlWatercraft, by=list(Category=WISP_Raw$OrgID, WISP_Raw$Direction), FUN=sum)
Watercraft.Freq <- aggregate(WISP_Raw$ttlWatercraft, by=list(Category=WISP_Raw$OrgID), FUN=sum)
Watercraft.Ttl.Merge <- merge(Watercraft.Tally, Watercraft.Freq, by.x="Category", by.y="Category", keep.x=TRUE) 

Watercraft.Ttl.Merge2 <- arrange(Watercraft.Ttl.Merge, desc(x.y)) %>% top_n(16)
names(Watercraft.Ttl.Merge2)[names(Watercraft.Ttl.Merge2) == "Group.2"] <- "Direction"

ggplot(Watercraft.Ttl.Merge2, aes(fill=Direction, x=reorder(Category, -x.y), y=x.x))+
  geom_text(aes(label=stat(y), group = Category), stat = 'summary', fun = sum, vjust=3, size=3)+
  geom_bar(stat="identity", position = "stack")+
  labs(x="Program", y="Number of Watercraft", caption ="Figure 2. Total number of watercraft inspected by organization (2021).")+
  theme(axis.text.x = element_text(angle = 90))


````

### Statewide Inspection Compliance

````{r prep, include=FALSE}

statewide.consent <- WISP_Raw %>% filter(InspectAgree=="Yes") %>% group_by(OrgID) %>% tally()
names(statewide.consent)[names(statewide.consent) == "n"] <- "Total.Consented"
statewide.byprogram <- WISP_Raw  %>% group_by(OrgID) %>% tally()
names(statewide.byprogram)[names(statewide.byprogram) == "n"] <- "Total.Surveys"
Consent.Merge <- merge(statewide.byprogram, statewide.consent, by.x="OrgID", by.y="OrgID", keep.x=TRUE)
Consent.Merge$Percent.Consent <- NA
Consent.Merge <- mutate(Consent.Merge, Percent.Consent = (Consent.Merge$Total.Consented/Consent.Merge$Total.Surveys)*100) 
Consent.Merge <- mutate(Consent.Merge, Percent.Consent=round(Percent.Consent, digits=2)) %>% filter(OrgID != "FLPRISM")
Consent.Merge.Plot <- arrange(Consent.Merge, desc(Percent.Consent)) %>% top_n(12)

Diff.State <- if((round((total.consent/count(WISP_SLELO)*100), digits = 0)<(round(mean(Consent.Merge.Plot$Percent.Consent),2)))){
  print("slightly below average")
} else{
  print("slightly above average")
}

````
Average inspection compliance across all NYS programs is **`r round(mean(Consent.Merge.Plot$Percent.Consent),0)`%**. SLELO program compliance is **`r Diff.State`** at approximately **`r percent.consent`%** compliance.

````{r statewide ttl compliance, echo=FALSE}

ggplot(Consent.Merge.Plot, aes(x=reorder(OrgID, -Percent.Consent), y=Percent.Consent))+
  geom_bar(stat="identity", fill="#3f97b4")+
  labs(x="Program", y="Percent Consenting to Inspection", caption ="Figure 2. Inspection compliation (%) by organization (2021).")+
  geom_text(aes(label=Percent.Consent, vjust = 3), color = "white", size = 3)+
  theme(axis.text.x = element_text(angle = 90))

````
